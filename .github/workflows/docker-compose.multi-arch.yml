version: '3.8'

services:
  nginx:
    image: nginx:alpine
    platform: linux/amd64  # 或者 linux/arm64
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/ssl/certs:ro
    depends_on:
      - kpi
      - kobocat
      - enketo
    restart: unless-stopped

  kpi:
    build:
      context: .
      dockerfile: Dockerfile
      platforms:
        - linux/amd64
        - linux/arm64
    image: kobo/kpi:latest
    environment:
      - DJANGO_SETTINGS_MODULE=kobo.settings.prod
    volumes:
      - kpi_media:/srv/src/kpi/media
    depends_on:
      - postgres
      - redis
    restart: unless-stopped

  kobocat:
    build:
      context: .
      dockerfile: Dockerfile.kobocat
      platforms:
        - linux/amd64
        - linux/arm64
    image: kobo/kobocat:latest
    environment:
      - DJANGO_SETTINGS_MODULE=onadata.settings.prod
    volumes:
      - kobocat_media:/srv/src/kobocat/media
    depends_on:
      - postgres
      - redis
    restart: unless-stopped

  enketo:
    build:
      context: .
      dockerfile: Dockerfile.enketo
      platforms:
        - linux/amd64
        - linux/arm64
    image: kobo/enketo:latest
    environment:
      - ENKETO_API_KEY=${ENKETO_API_KEY}
    depends_on:
      - redis
    restart: unless-stopped

  postgres:
    image: postgres:13
    platform: linux/amd64  # PostgreSQL支持多架构
    environment:
      - POSTGRES_DB=kobotoolbox
      - POSTGRES_USER=kobo
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups/postgres:/backups
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    platform: linux/amd64  # Redis支持多架构
    volumes:
      - redis_data:/data
    restart: unless-stopped

  mongodb:
    image: mongo:4.4
    platform: linux/amd64  # MongoDB支持多架构
    volumes:
      - mongo_data:/data/db
      - ./backups/mongo:/backups
    restart: unless-stopped

volumes:
  kpi_media:
  kobocat_media:
  postgres_data:
  redis_data:
  mongo_data:
